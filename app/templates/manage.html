<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transit Victoria â€” {% if mode == 'setup' %}Setup{% else %}Settings{% endif %}</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: rgb(21 21 21);
      color: #e0e0e0;
      min-height: 100vh;
    }

    /* Top bar */
    .topbar {
      background:rgb(21 21 21);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .topbar-logo {
      width: 28px;
      height: 28px;
      background: #f8654b;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      font-size: 14px;
      color: #fff;
    }
    .topbar-title {
      font-size: 15px;
      font-weight: 500;
      color: #fff;
    }

    .wrap { max-width: 520px; margin: 32px auto; padding: 0 16px; }

    h1 { font-size: 24px; font-weight: 400; color: #fff; margin-bottom: 4px; }
    .subtitle { font-size: 14px; color: rgb(143 143 143); margin-bottom: 28px; }

    .card {
      background: rgb(24 24 24);
      border: 1px solid rgb(91 91 91);
      border-radius: 10px;
      padding: 28px;
    }

    label {
      display: block;
      font-size: 12px;
      font-weight: 400;
      color: rgb(143 143 143);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .hint { font-size: 12px; color: rgb(143 143 143); margin-top: 6px; margin-bottom: 16px; }

    input[type="text"] {
      width: 100%;
      padding: 10px 14px;
      background: rgb(21 21 21);
      border: 1px solid rgb(91 91 91);
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      color: #e0e0e0;
      outline: none;
      transition: border-color 0.15s;
    }
    input[type="text"]::placeholder { color: rgb(143 143 143); }
    input[type="text"]:focus { border-color: #f8654b; }

    select {
      width: 100%;
      padding: 10px 14px;
      background: rgb(21 21 21);
      border: 1px solid rgb(91 91 91);
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      color: #e0e0e0;
      outline: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%238f8f8f' d='M6 8L0 0h12z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      cursor: pointer;
      transition: border-color 0.15s;
    }
    select:focus { border-color: #f8654b; }

    /* Search dropdown */
    .search-results {
      border: 1px solid rgb(91 91 91);
      border-radius: 8px;
      margin-top: 4px;
      max-height: 220px;
      overflow-y: auto;
      display: none;
      background: rgb(21 21 21);
    }
    .search-results.open { display: block; }
    .search-result {
      padding: 10px 14px;
      cursor: pointer;
      font-size: 14px;
      color: #e0e0e0;
      border-bottom: 1px solid rgb(91 91 91);
      transition: background 0.1s;
    }
    .search-result:last-child { border-bottom: none; }
    .search-result:hover { background: rgb(30 30 30); }
    .search-result .stop-id { font-size: 11px; color: rgb(143 143 143); margin-left: 6px; }

    /* Current station badge */
    .current {
      background: rgb(21 21 21);
      border: 1px solid rgb(91 91 91);
      border-radius: 8px;
      padding: 14px 16px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .current-icon {
      width: 40px;
      height: 40px;
      background: #f96527;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .current-icon svg { width: 20px; height: 20px; fill: #fff; }
    .current-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: rgb(143 143 143);
      margin-bottom: 2px;
    }
    .current-value { font-size: 16px; font-weight: 500; color: #fff; }

    .field { margin-bottom: 20px; }

    /* Button */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 24px;
      background: #f8654b;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.15s;
    }
    .btn:hover { background: #d15019; }

    .btn-row {
      margin-top: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .back-link {
      font-size: 13px;
      color: #8888aa;
      text-decoration: none;
      transition: color 0.15s;
    }
    .back-link:hover { color: #fff; }

    /* Status messages */
    .msg {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      font-weight: 500;
    }
    .msg-ok { background: #0d2818; color: #4ade80; border: 1px solid #166534; }
    .msg-err { background: #2d0f0f; color: #f87171; border: 1px solid #7f1d1d; }

    /* Scrollbar */
    .search-results::-webkit-scrollbar { width: 6px; }
    .search-results::-webkit-scrollbar-track { background: transparent; }
    .search-results::-webkit-scrollbar-thumb { background: #2a2a4a; border-radius: 3px; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-logo">T</div>
    <span class="topbar-title">Transit Victoria for TRMNL</span>
  </div>

  <div class="wrap">
    {% if mode == 'setup' %}
    <h1>Welcome to Transit Victoria</h1>
    <p class="subtitle">Choose your station to get started</p>
    {% else %}
    <h1>Settings</h1>
    <p class="subtitle">Configure your train departure display</p>
    {% endif %}

    {% if message %}
    <div class="msg {{ 'msg-ok' if message_type == 'success' else 'msg-err' }}">{{ message }}</div>
    {% endif %}

    <div class="card">
      {% if mode != 'setup' %}
      <div class="current">
        <div class="current-icon">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C8 2 4 3.5 4 7v9.5C4 18.43 5.57 20 7.5 20L6 21.5v.5h2l2-2h4l2 2h2v-.5L16.5 20c1.93 0 3.5-1.57 3.5-3.5V7c0-3.5-4-5-8-5zM7.5 17c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm3.5-6H6V7h5v4zm2 0V7h5v4h-5zm3.5 6c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
        </div>
        <div>
          <div class="current-label">Current station</div>
          <div class="current-value">{{ station_name }}{% if platform_numbers %} <span style="font-weight:400;color:rgb(143 143 143);">Plat {{ platform_numbers }}</span>{% endif %}</div>
        </div>
      </div>
      {% endif %}

      <form method="POST" action="{% if mode == 'setup' %}/setup/save{% else %}/manage/save{% endif %}" id="settings-form">
        {% if mode == 'setup' %}
        <input type="hidden" name="callback_url" value="{{ callback_url }}">
        <input type="hidden" name="token" value="{{ token }}">
        {% else %}
        <input type="hidden" name="uuid" value="{{ uuid }}">
        {% endif %}
        <input type="hidden" name="stop_id" id="stop_id" value="{{ stop_id }}">
        <input type="hidden" name="station_name" id="station_name_hidden" value="{{ station_name }}">

        <div class="field">
          <label for="search">Search station</label>
          <input type="text" id="search" placeholder="e.g. Flinders Street" autocomplete="off">
          <div class="search-results" id="results"></div>
        </div>

        <div class="field">
          <label for="platform_numbers">Platform filter</label>
          <input type="text" name="platform_numbers" id="platform_numbers" value="{{ platform_numbers or '' }}" placeholder="e.g. 1,2">
          <p class="hint">Comma-separated. Leave blank for all platforms.</p>
        </div>

        <div class="field">
          <label for="refresh_minutes">Refresh every</label>
          <select name="refresh_minutes" id="refresh_minutes">
            {% for mins in [5, 10, 15, 30, 60] %}
            <option value="{{ mins }}" {% if refresh_minutes == mins %}selected{% endif %}>{{ mins }} minutes</option>
            {% endfor %}
          </select>
          <p class="hint">How often your display fetches new departure times.</p>
        </div>

        <div class="btn-row">
          {% if mode == 'setup' %}
          <button type="submit" class="btn">Save & Continue</button>
          <a class="back-link" href="{{ callback_url }}">Skip setup</a>
          {% else %}
          <button type="submit" class="btn">Save settings</button>
          {% if plugin_setting_id %}
          <a class="back-link" href="https://usetrmnl.com/plugin_settings/{{ plugin_setting_id }}?force_refresh=true">Back to TRMNL</a>
          {% endif %}
          {% endif %}
        </div>
      </form>
    </div>
  </div>

  <script>
    const searchInput = document.getElementById('search');
    const resultsDiv = document.getElementById('results');
    const stopIdInput = document.getElementById('stop_id');
    const stationNameInput = document.getElementById('station_name_hidden');
    let debounceTimer;

    searchInput.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      const q = searchInput.value.trim();
      if (q.length < 2) { resultsDiv.classList.remove('open'); return; }
      debounceTimer = setTimeout(() => fetchStations(q), 300);
    });

    async function fetchStations(q) {
      try {
        const res = await fetch('/api/stations/search?q=' + encodeURIComponent(q));
        const data = await res.json();
        if (!data.stops || data.stops.length === 0) {
          resultsDiv.innerHTML = '<div class="search-result" style="color:#6666888;">No stations found</div>';
        } else {
          resultsDiv.innerHTML = data.stops.map(s =>
            '<div class="search-result" data-id="' + s.stop_id + '" data-name="' + s.stop_name.replace(/"/g, '&quot;') + '">'
            + s.stop_name + '<span class="stop-id">#' + s.stop_id + '</span></div>'
          ).join('');
          resultsDiv.querySelectorAll('.search-result').forEach(el => {
            el.addEventListener('click', () => selectStation(el));
          });
        }
        resultsDiv.classList.add('open');
      } catch (e) {
        resultsDiv.innerHTML = '<div class="search-result" style="color:#f87171;">Search failed</div>';
        resultsDiv.classList.add('open');
      }
    }

    function selectStation(el) {
      stopIdInput.value = el.dataset.id;
      stationNameInput.value = el.dataset.name;
      searchInput.value = el.dataset.name;
      resultsDiv.classList.remove('open');
    }

    document.addEventListener('click', (e) => {
      if (!resultsDiv.contains(e.target) && e.target !== searchInput) {
        resultsDiv.classList.remove('open');
      }
    });
  </script>
</body>
</html>
